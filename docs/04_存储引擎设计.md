# 存储引擎设计

## 概述
分页存储模型，结合异步I/O和缓冲池管理，提供高效的数据访问性能。

## 架构
```
应用层 → 缓冲池管理器 → 异步磁盘管理器 → 磁盘存储 → 物理磁盘
```

## 核心组件
```
include/storage/
├── disk_manager.h              # 磁盘管理器
├── buffer_pool_manager.h       # 缓冲池管理器
├── async_disk_manager.h        # 异步磁盘管理器
└── async_buffer_pool_manager.h # 异步缓冲池管理器

src/storage/
├── disk_manager.cpp           # 磁盘管理器实现
├── buffer_pool_manager.cpp    # 缓冲池管理器实现
├── async_disk_manager.cpp     # 异步磁盘管理器实现
└── async_buffer_pool_manager.cpp # 异步缓冲池管理器实现
```

## 磁盘管理器 (DiskManager)

### 主要功能
- 页面读写操作
- 页面分配和回收
- 文件管理

### 接口
```cpp
class DiskManager {
public:
    void ReadPage(page_id_t page_id, char* page_data);
    void WritePage(page_id_t page_id, const char* page_data);
    page_id_t AllocatePage();
    void DeallocatePage(page_id_t page_id);
};
```

## 缓冲池管理器 (BufferPoolManager)

### 主要功能
- 内存页面缓存
- 页面替换策略（LRU）
- 脏页管理

### 接口
```cpp
class BufferPoolManager {
public:
    Page* FetchPage(page_id_t page_id);
    bool UnpinPage(page_id_t page_id, bool is_dirty);
    bool FlushPage(page_id_t page_id);
    Page* NewPage(page_id_t* page_id);
    bool DeletePage(page_id_t page_id);
};
```

## 异步磁盘管理器 (AsyncDiskManager)

### 主要功能
- 异步I/O操作
- 工作线程池
- 任务队列管理

### 线程安全
- `std::mutex queue_mutex_` - 保护任务队列
- `std::condition_variable queue_cv_` - 线程同步
- `std::atomic<bool> should_stop_` - 停止标志

### 使用方式
```cpp
AsyncDiskManager async_dm("database.db");
async_dm.Start();

// 异步读取页面
auto future = async_dm.ReadPageAsync(page_id, page_data);
future.wait();  // 等待完成

async_dm.Stop();
```

## 页面结构

### Page类
```cpp
class Page {
public:
    page_id_t GetPageId() const;
    char* GetData();
    bool IsDirty() const;
    int GetPinCount() const;
    
private:
    page_id_t page_id_;
    char data_[PAGE_SIZE];
    bool is_dirty_;
    int pin_count_;
    std::mutex latch_;
};
```

### 页面大小
- 默认页面大小：4KB (4096字节)
- 页面头部：包含页面元数据
- 页面数据：存储实际记录数据

## 性能优化

### 缓冲池优化
- LRU页面替换算法
- 预读机制
- 批量写入优化

### 异步I/O优化
- 工作线程池减少线程创建开销
- 任务队列批量处理
- 非阻塞I/O操作

### 并发控制
- 页面级锁定
- 读写锁分离
- 无锁数据结构优化